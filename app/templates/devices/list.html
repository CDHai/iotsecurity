{% extends "base.html" %}

{% block title %}Devices - IoT Security Framework{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-0">
                <i class="fas fa-microchip me-2"></i>IoT Devices
            </h1>
            <p class="text-muted">Manage and monitor your IoT devices</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <button class="btn btn-success" onclick="startNetworkScan()">
                    <i class="fas fa-search me-1"></i>Network Scan
                </button>
                {% if current_user.can_access('write') %}
                <a href="{{ url_for('devices.add_device') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Add Device
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           placeholder="IP address, hostname, manufacturer..." 
                           value="{{ search }}">
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">Device Type</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">All Types</option>
                        <option value="camera" {{ 'selected' if device_type == 'camera' }}>Camera</option>
                        <option value="router" {{ 'selected' if device_type == 'router' }}>Router</option>
                        <option value="sensor" {{ 'selected' if device_type == 'sensor' }}>Sensor</option>
                        <option value="switch" {{ 'selected' if device_type == 'switch' }}>Switch</option>
                        <option value="lock" {{ 'selected' if device_type == 'lock' }}>Smart Lock</option>
                        <option value="unknown" {{ 'selected' if device_type == 'unknown' }}>Unknown</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">All Status</option>
                        <option value="active" {{ 'selected' if status == 'active' }}>Active</option>
                        <option value="inactive" {{ 'selected' if status == 'inactive' }}>Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Devices Table -->
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="card-title mb-0">
                        Devices 
                        <span class="badge bg-secondary">{{ devices.total }}</span>
                    </h5>
                </div>
                <div class="col-auto">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="refreshDevices()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-download"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportDevices('csv')">
                                    <i class="fas fa-file-csv me-1"></i>Export CSV
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportDevices('json')">
                                    <i class="fas fa-file-code me-1"></i>Export JSON
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if devices.items %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>IP Address</th>
                        <th>Hostname</th>
                        <th>Type</th>
                        <th>Manufacturer</th>
                        <th>Risk Level</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices.items %}
                    <tr>
                        <td>
                            <span class="device-status {{ 'online' if device.is_active else 'offline' }}" 
                                  title="{{ 'Online' if device.is_active else 'Offline' }}"></span>
                        </td>
                        <td>
                            <a href="{{ url_for('devices.view_device', device_id=device.id) }}" 
                               class="text-decoration-none fw-bold">
                                {{ device.ip_address }}
                            </a>
                        </td>
                        <td>
                            {{ device.hostname or '-' }}
                            {% if device.mac_address %}
                            <br><small class="text-muted">{{ device.mac_address }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.device_type %}
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-{{ 'video' if device.device_type == 'camera' else 
                                                      'router' if device.device_type == 'router' else 
                                                      'thermometer-half' if device.device_type == 'sensor' else 
                                                      'toggle-on' if device.device_type == 'switch' else 
                                                      'lock' if device.device_type == 'lock' else 
                                                      'microchip' }} me-1"></i>
                                    {{ device.device_type.title() }}
                                </span>
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>{{ device.manufacturer or '-' }}</td>
                        <td>
                            <span class="badge risk-{{ device.risk_level or 'unknown' }}">
                                {{ device.risk_level.title() if device.risk_level else 'Unknown' }}
                            </span>
                            {% if device.vulnerability_count > 0 %}
                            <br><small class="text-danger">
                                <i class="fas fa-bug me-1"></i>{{ device.vulnerability_count }} issues
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.last_seen %}
                                <span title="{{ device.last_seen.strftime('%Y-%m-%d %H:%M:%S') }}">
                                    {{ device.last_seen.strftime('%m/%d %H:%M') }}
                                </span>
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('devices.view_device', device_id=device.id) }}" 
                                   class="btn btn-outline-primary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if current_user.can_access('run_assessments') %}
                                <button class="btn btn-outline-success" 
                                        onclick="startQuickAssessment({{ device.id }})" 
                                        title="Quick Assessment">
                                    <i class="fas fa-search"></i>
                                </button>
                                {% endif %}
                                {% if current_user.can_access('write') %}
                                <button class="btn btn-outline-info" 
                                        onclick="rescanDevice({{ device.id }})" 
                                        id="rescan-btn-{{ device.id }}"
                                        title="Rescan Device">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <a href="{{ url_for('devices.edit_device', device_id=device.id) }}" 
                                   class="btn btn-outline-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                                {% if current_user.can_access('delete') %}
                                <button class="btn btn-outline-danger btn-delete" 
                                        onclick="deleteDevice({{ device.id }})" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if devices.pages > 1 %}
        <div class="card-footer">
            <nav aria-label="Device pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if devices.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('devices.list_devices', page=devices.prev_num, search=search, type=device_type, status=status) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in devices.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != devices.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('devices.list_devices', page=page_num, search=search, type=device_type, status=status) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if devices.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('devices.list_devices', page=devices.next_num, search=search, type=device_type, status=status) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <div class="card-body text-center py-5">
            <i class="fas fa-microchip fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Devices Found</h5>
            <p class="text-muted mb-4">
                {% if search or device_type or status %}
                    No devices match your current filters.
                {% else %}
                    Start by scanning your network to discover IoT devices.
                {% endif %}
            </p>
            <div class="btn-group">
                {% if search or device_type or status %}
                <a href="{{ url_for('devices.list_devices') }}" class="btn btn-outline-primary">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </a>
                {% endif %}
                <button class="btn btn-primary" onclick="startNetworkScan()">
                    <i class="fas fa-search me-1"></i>Start Network Scan
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Network Scan Modal -->
<div class="modal fade" id="networkScanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-network-wired me-2"></i>Network Discovery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="networkScanForm">
                    <div class="mb-3">
                        <label for="networkRange" class="form-label">Network Range</label>
                        <input type="text" class="form-control" id="networkRange" 
                               placeholder="192.168.1.0/24" value="192.168.1.0/24" required>
                        <div class="form-text">Enter the network range to scan in CIDR notation</div>
                    </div>
                    <div class="mb-3">
                        <label for="scanType" class="form-label">Scan Type</label>
                        <select class="form-select" id="scanType">
                            <option value="ping">Ping Scan (Fast)</option>
                            <option value="tcp_connect" selected>TCP Connect (Recommended)</option>
                            <option value="tcp_syn">TCP SYN (Advanced)</option>
                        </select>
                        <div class="form-text">Choose scan method based on your network and permissions</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeNetworkScan()">
                    <i class="fas fa-play me-1"></i>Start Scan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Assessment Modal -->
<div class="modal fade" id="quickAssessmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Quick Security Assessment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will run a quick security assessment on the selected device.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Quick Assessment includes:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Default credential check</li>
                        <li>Open port analysis</li>
                        <li>Basic web security tests</li>
                        <li>Common vulnerability checks</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmQuickAssessment">
                    <i class="fas fa-play me-1"></i>Start Assessment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedDeviceId = null;

function startNetworkScan() {
    $('#networkScanModal').modal('show');
}

function executeNetworkScan() {
    const networkRange = $('#networkRange').val();
    const scanType = $('#scanType').val();
    
    if (!networkRange) {
        showAlert('Please enter a network range', 'error');
        return;
    }
    
    $('#networkScanModal').modal('hide');
    showAlert('Network scan started. This may take several minutes...', 'info');
    
    // Simulate network scan API call
    setTimeout(() => {
        showAlert('Network scan completed successfully!', 'success');
        location.reload();
    }, 3000);
}

function startQuickAssessment(deviceId) {
    selectedDeviceId = deviceId;
    $('#quickAssessmentModal').modal('show');
}

$('#confirmQuickAssessment').click(function() {
    if (!selectedDeviceId) return;
    
    $('#quickAssessmentModal').modal('hide');
    showAlert('Quick assessment started...', 'info');
    
    // Simulate assessment API call
    setTimeout(() => {
        showAlert('Quick assessment completed!', 'success');
        window.location.href = `/assessments/`;
    }, 2000);
});

function deleteDevice(deviceId) {
    if (!confirm('Are you sure you want to delete this device? This action cannot be undone.')) {
        return;
    }
    
    // Simulate delete API call
    showAlert('Device deleted successfully!', 'success');
    setTimeout(() => location.reload(), 1000);
}

function refreshDevices() {
    location.reload();
}

function exportDevices(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.location.href = `/api/devices/export?${params.toString()}`;
}
</script>
{% endblock %}
